<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Webpage with map</title>
<style>
      html, body, #mapArea {
        height: 90%;
        margin: 0px;
        padding: 0px
      }
    </style>
<!-- Google maps javascript API -->
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
<script type="text/javascript">
var map;
var fullForm;
var singleKmls=[];//The KmlLayers created by the singleOn method, newest in [0], in age order
var singleKmlNames=[];//The strings corresponding to the KmlLayers created by the singleOn method, newest in [0], in age order

function setUpMap(){
	alert("loading page");//used to show/prove page is not reloading
	var mapOptions = {
		     zoom: 9,
		     center: new google.maps.LatLng(51.2, -0.8)
		  };
	map = new google.maps.Map(document.getElementById('mapArea'),
		      mapOptions);
	downloadFullList();
	setUpInitialKmls();
}
function downloadFullList(){//NB show-all does not actually show all possible tags, and some shown tags seem not to work.
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.onreadystatechange = function() {
	if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
		setUpFullKmlList(JSON.parse(xmlhttp.responseText));
	    }
	}
	xmlhttp.open("GET", "https://sturents.com/geo/show-all", true);
	xmlhttp.send();
}
function setUpFullKmlList(showAll){
	fullForm = document.createElement("form");
	var formElem;
	var place;
	for(place in showAll){//place goes through the numbers, we use the names showAll[place]
		//Create a checkbox
		formElem = document.createElement("input");
		formElem.type = "checkbox";
		formElem.name =showAll[place];
		formElem.setAttribute("onclick","if(checked){singleOn(name);}else{singleOff(name)}");
		//Add it to the form
		fullForm.appendChild(formElem);
		//Add the name after the checkbox
		fullForm.appendChild(document.createTextNode(showAll[place]));
	}
	document.getElementById("fullCheckboxDiv").appendChild(fullForm);
}
//To change - see if can set to be called by changes to the has
function setUpInitialKmls(){
	//format is: ...MapPage.html#aaaaa&bbbbb&cccc...
	//Note that a Google map can only display so many layers
	var targets = new Array(0);
	//Get an Array of all given locations
	if(window.location.hash.length!=0){
		targets=window.location.hash.substring(1).split("&");		
	}
	for(i=0;i<targets.length;i++){
		//TODO
		//check checkbox and add to map
		//fullForm.targets[i].checked=true;
		addKml(targets[i]);
	}
	//Would like to check if valid target, but status is not updated until call setMap (and it just returns OK anyway, and zooms out to whole world)
}
function addKml(urlname){//separate method so can also be called when url is changed
	var newKml =new google.maps.KmlLayer();
	newKml.setUrl("https://sturents.com/geo/"+urlname+".kml");
	newKml.setMap(map);
	singleKmls.splice(0,0,newKml);
	singleKmlNames.splice(0,0,urlname);
}
//Don't bother with order, just stick on end, do random access - when doing 1 at a time order adds nothing of use.
function singleOn(urlname){
	//Append urlname to shown kmls in url
	addKml(urlname);
	if(window.location.hash.length=<1){//no current kmls in url
		window.location.hash+=(urlname);
	}else{//there are kmls in url
		window.location.hash+=("&"+urlname);
	}//using hash '#' rather than search '?' makes url work nicely (search reloads page)
	//BUT back goes straight to nothing at all (in location.hash), leavng map/page same.
	//see window.onhashchange, pushState()
}
function singleOff(urlname){
	var index = singleKmlNames.indexOf(urlname);
	if(index!=-1){
		singleKmls[index].setMap(null);
		singleKmls.splice(index,1);
		singleKmlNames.splice(index,1);
		//remove urlname from url
		var paramStart = window.location.hash.indexOf(urlname);
		if(paramStart!=-1){//i.e. it's in the url
			var newHashStart = window.location.hash.substring(0,paramStart);
			var newHashEnd = window.location.hash.substring(paramStart+urlname.length)
			if(newHashEnd.length==0){//if no subsequent location in url, remove last symbol from newHashStart and set as the hash
				window.location.hash=newHashStart.substring(0,newHashStart.length-1); 
			}else{//remove the head element of newHashEnd (will be '&'), and set hash to be newHashStart followed by newHashEnd
				window.location.hash=newHashStart+newHashEnd.substring(1,newHashEnd.length);
			}
		}
	}	
}

google.maps.event.addDomListener(window, 'load', setUpMap);
</script>
</head>
<body>
<p>
Map will go below when put in.
</p>
<div id="mapArea"></div>
<!-- Div to hold a dynamically generated form from https://sturents.com/geo/show-all -->
<div id="fullCheckboxDiv"></div>
</body>
</html>