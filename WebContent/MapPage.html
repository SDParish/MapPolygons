<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Webpage with map</title>
<style>
      html, body, #mapArea {
        height: 90%;
        margin: 0px;
        padding: 0px
      }
    </style>
<!-- Setup to get data from form based on http://www.quirksmode.org/js/formex.html -->
<!-- Google maps javascript API -->
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
<script type="text/javascript">
var kmls;
var kmlsShown;
var map;
var kmlLayerTest;
var fullForm;
var fullFormPlaceCount;
var fullFormShowList;//Store the indicies (in fullForm) of the checkboxes for each kml
var fullFormKmls;//The corresponding KmlLayers for each index in fullFormShowList

function setUpMap(){
	var mapOptions = {
		     zoom: 9,
		     center: new google.maps.LatLng(51.2, -0.8)
		  };
	map = new google.maps.Map(document.getElementById('mapArea'),
		      mapOptions);
	downloadFullList();
	setUpKML();
	setUpKmlArray();
}
function downloadFullList(){//NB show-all does not actually show all possible tags.
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.onreadystatechange = function() {
	if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
		setUpFullKmlList(JSON.parse(xmlhttp.responseText));
	    }
	}
	xmlhttp.open("GET", "https://sturents.com/geo/show-all", true);
	xmlhttp.send();
}
function setUpFullKmlList(showAll){
	fullForm = document.createElement("form");
	fullFormPlaceCount=0;
	var formElem;
	var place;
	for(place in showAll){//place goes through the numbers, we use the names showAll[place]
		//Create a checkbox
		formElem = document.createElement("input");
		formElem.type = "checkbox";
		formElem.name =showAll[place];
		//Add it to the form
		fullForm.appendChild(formElem);
		//Add the name after the checkbox
		fullForm.appendChild(document.createTextNode(showAll[place]));
		fullFormPlaceCount++;
	}
	//Now add a button to update the map
		formElem = document.createElement("input");
		formElem.type = "button";
		formElem.value="Update map"; 
		formElem.setAttribute("onclick"," updateKmls(); return false");
		fullForm.appendChild(formElem);
	document.getElementById("fullCheckboxDiv").appendChild(fullForm);
	fullFormShowList = [];
	fullFormKmls = [];
}
function updateKmls(){
	//maintain ordered list/Array of displayed elements
	//each cycle of loop, at arrayPosit in fullFormKmlList, where elements[fullFormKmlList[0...arrayPosit-1]].name are alphabetically <= elements[elementPosit].name <= elements[fullFormKmlList[arrayPosit]].name<elements[fullFormKmlList[arrayPosit+1....length]].name
	var arrayPosit =0;
	var newKml;
	for(var elementPosit=0;elementPosit<fullFormPlaceCount;elementPosit++){
		if(fullFormShowList[arrayPosit]==elementPosit){//if element is in the list
			if(!(fullForm.elements[elementPosit].checked)){
				//Here following the remove entirely idea. Could store 'recent locations' if think user might want to see them again
				fullFormShowList.splice(arrayPosit,1);
				fullFormKmls[arrayPosit].setMap(null);
				fullFormKmls.splice(arrayPosit,1);
				//arrayPosit stays same
			}else{
				arrayPosit++;
			}
		}else{//if element is NOT in the list
			if(fullForm.elements[elementPosit].checked){
				fullFormShowList.splice(arrayPosit,0,elementPosit);
				newKml =new google.maps.KmlLayer();
				newKml.setUrl("https://sturents.com/geo/"+fullForm.elements[elementPosit].name+".kml");
				newKml.setMap(map);
				fullFormKmls.splice(arrayPosit,0,newKml);
				arrayPosit++;
			}//else arrayPosit stays the same
		}		
	}
}
function setUpKML(){
	kmlLayerTest = new google.maps.KmlLayer();
	kmlLayerTest.setUrl("https://sturents.com/geo/farnham-bourne-ward.kml");//Works, but using local copies doesn't
}
function setUpKmlArray(){
	kmls = new Array(6);
	kmlsShown = new Array(6);
	for (i=0;i<6;i++) {
		kmlsShown[i]=false;
	}	
}
function test(){
   if(kmlLayerTest.getMap()==map){
	   kmlLayerTest.setMap(null);
   }else{
	   kmlLayerTest.setMap(map);
   }
}
function toggleKmls(){
	for (i=0;i<6;i++) {
		if(document.checkboxForm.elements[i].checked!=kmlsShown[i]){
			if(kmlsShown[i]){
				//could change to removing the kml from kmls - depends on whether having previously selected it means it may want to be selected again, and the costs of recreation vs storage
				kmls[i].setMap(null);
			}else{
				if(kmls[i]==null){
					kmls[i]= new google.maps.KmlLayer();
					kmls[i].setUrl("https://sturents.com/geo/"+document.checkboxForm.elements[i].name+".kml");
					alert("Created: "+document.checkboxForm.elements[i].name);
				}
				kmls[i].setMap(map);
			}
			kmlsShown[i]=!kmlsShown[i];
	   }
	}	
}

google.maps.event.addDomListener(window, 'load', setUpMap);
</script>
</head>
<body>
<p>
Map will go below when put in.
</p>
<div id="mapArea"></div>
<form name="checkboxForm" action="#" method="get">
<!-- //reading-b-, reading, guildford-district-b-, guildford, surrey-county, surrey -->
<input type="checkbox" name="reading-b-">reading-b-
<input type="checkbox" name="kingston-upon-thames-london-boro">kingston-upon-thames-london-boro
<input type="checkbox" name="guildford-district-b-">guildford-district-b-
<input type="checkbox" name="guildford">guildford
<input type="checkbox" name="surrey-county">surrey-county
<input type="checkbox" name="surrey">surrey
<input type="button" name="refresh" value="Update map" onclick="toggleKmls(); return false"/>

</form>
<!-- Div to hold a dynamically generated form from https://sturents.com/geo/show-all -->
<div id="fullCheckboxDiv"></div>
<input type="button" onclick="test()" value="No, click ME" />
</body>
</html>