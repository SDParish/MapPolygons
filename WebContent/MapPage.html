<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Webpage with map</title>
<style>
      html, body, #mapArea {
        height: 90%;
        margin: 0px;
        padding: 0px
      }
    </style>
<!-- Google maps javascript API -->
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
<script type="text/javascript">
var map;
var fullForm;
var singleKmls=[];//The KmlLayers created by the singleOn method, newest in [0], in age order
var singleKmlNames=[];//The strings corresponding to the KmlLayers created by the singleOn method, newest in [0], in age order

function setUpMap(){
	alert("loading page");//used to show/prove page is not reloading
	var mapOptions = {
		     zoom: 9,
		     center: new google.maps.LatLng(51.2, -0.8)
		  };
	map = new google.maps.Map(document.getElementById('mapArea'),mapOptions);
	downloadFullList();//This is partly asynchronous, so may not be complete before subsequent actions
}
function downloadFullList(){//NB show-all does not actually show all possible tags, and some shown tags seem not to work.
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.onreadystatechange = function() {
	if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
		setUpFullKmlList(JSON.parse(xmlhttp.responseText));
	    }
	}
	xmlhttp.open("GET", "https://sturents.com/geo/show-all", true);
	xmlhttp.send();
}
function setUpFullKmlList(showAll){
	fullForm = document.createElement("form");
	fullForm.name = "fullForm";
	var formElem;
	var place;
	for(place in showAll){//place goes through the numbers, we use the names showAll[place]
		//Create a checkbox
		formElem = document.createElement("input");
		formElem.type = "checkbox";
		formElem.name =showAll[place];
		formElem.setAttribute("onclick","if(checked){singleOn(name);}else{singleOff(name)}");
		//Add it to the form
		fullForm.appendChild(formElem);
		//Add the name after the checkbox
		fullForm.appendChild(document.createTextNode(showAll[place]));
	}
	document.getElementById("fullCheckboxDiv").appendChild(fullForm);
	//below here to ensure that the form is set up when ut runs
	setUpInitialKmls();
}
//See if can set to be called by manual changes to the hash - will need to see if triggered by singleOn/Off
//window.onhashchange triggered by page reload, but not by typing in url and clicking elsewhere, or by singleOn/Off
//TODO edit to include colours (optional eg name&name2[coldata]&... ) not sure on scheme yet. Will need to store default colour string
function setUpInitialKmls(){
	//format is: ...MapPage.html#aaaaa&bbbbb&cccc...
	//Note that a Google map can only display so many layers
	var targets = new Array(0);
	//Get an Array of all given locations
	if(window.location.hash.length>1){
		targets=window.location.hash.substring(1).split("&");		
	}
	//Add new kmls
	for(i=0;i<targets.length;i++){
		//check not already shown
		if(singleKmlNames.indexOf(targets[i])==-1){
			//check checkbox and add to map
			addKml(targets[i]);	
			for(j=0;j<fullForm.elements.length;j++){
				if(fullForm.elements[j].name==targets[i]){
					fullForm.elements[j].checked =!fullForm.elements[j].checked;
					j=fullForm.elements.length;
				}
			}
		}
	}
}
function addKml(urlname){//separate method so can also be called when url is changed
	var newKml =new google.maps.KmlLayer();
	alert("http://178.62.107.109/testUpload/kmlColourSetter.php?url="+urlname+".kml&col="+document.colourForm.lineColour.value);
	newKml.setUrl("http://178.62.107.109/testUpload/kmlColourSetter.php?url="+urlname+".kml&col="+document.colourForm.lineColour.value);
	newKml.setMap(map);
	singleKmls.splice(0,0,newKml);
	singleKmlNames.splice(0,0,urlname);
}
//Don't bother with order, just stick on end, do random access - when doing 1 at a time order adds nothing of use.
function singleOn(urlname){
	//Append urlname to shown kmls in url
	//check not already shown
	if(singleKmlNames.indexOf(urlname)==-1){
		addKml(urlname);
		if(window.location.hash.length>1){//there are kmls in url
			window.location.hash+=("&"+urlname);
		}else{//no current kmls in url
			window.location.hash+=(urlname);
		}//using hash '#' rather than search '?' makes url work nicely (search reloads page)
	}//BUT back goes straight to nothing at all shown (does go 'back' in terms of the [now unshown] hash), leavng map/page same.
		//see window.onhashchange, pushState()
}
function singleOff(urlname){
	var index = singleKmlNames.indexOf(urlname);
	if(index!=-1){
		singleKmls[index].setMap(null);
		singleKmls.splice(index,1);
		singleKmlNames.splice(index,1);
		//remove urlname from url
		var paramStart = window.location.hash.indexOf(urlname);
		if(paramStart!=-1){//i.e. it's in the url
			var newHashStart = window.location.hash.substring(0,paramStart);
			var newHashEnd = window.location.hash.substring(paramStart+urlname.length)
			if(newHashEnd.length==0){//if no subsequent location in url, remove last symbol from newHashStart and set as the hash
				window.location.hash=newHashStart.substring(0,newHashStart.length-1); 
			}else{//remove the head element of newHashEnd (will be '&'), and set hash to be newHashStart followed by newHashEnd
				window.location.hash=newHashStart+newHashEnd.substring(1,newHashEnd.length);
			}
		}
	}	
}
google.maps.event.addDomListener(window, 'load', setUpMap);
</script>
</head>
<body>
<p>
Map will go below when put in.
</p>
<div id="mapArea"></div>
<form name="colourForm" action="#" method="get">
Line colour: <input type="text" name="lineColour" value="ffe89e40" maxlength=8>
</form>
<!-- Div to hold a dynamically generated form from https://sturents.com/geo/show-all -->
<div id="fullCheckboxDiv"></div>
</body>
</html>