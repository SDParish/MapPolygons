<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Webpage with map</title>
<style>
      html, body, #mapArea {
        height: 90%;
        margin: 0px;
        padding: 0px
      }
    </style>
<!-- Google maps javascript API -->
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
<script type="text/javascript">
var kmls;
var kmlsShown;
var map;
var fullForm;
var fullFormPlaceCount;

function setUpMap(){
	alert("loading page");//used to show/prove page is not reloading
	var mapOptions = {
		     zoom: 9,
		     center: new google.maps.LatLng(51.2, -0.8)
		  };
	map = new google.maps.Map(document.getElementById('mapArea'),
		      mapOptions);
	downloadFullList();
	setUpKmlArray();
}
function downloadFullList(){//NB show-all does not actually show all possible tags, and some shown tags seem not to work.
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.onreadystatechange = function() {
	if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
		setUpFullKmlList(JSON.parse(xmlhttp.responseText));
	    }
	}
	xmlhttp.open("GET", "https://sturents.com/geo/show-all", true);
	xmlhttp.send();
}
function setUpFullKmlList(showAll){
	fullForm = document.createElement("form");
	fullFormPlaceCount=0;
	var formElem;
	var place;
	for(place in showAll){//place goes through the numbers, we use the names showAll[place]
		//Create a checkbox
		formElem = document.createElement("input");
		formElem.type = "checkbox";
		formElem.name =showAll[place];
		formElem.setAttribute("onclick","if(checked){singleOn(name);}else{singleOff(name)}")
		//Add it to the form
		fullForm.appendChild(formElem);
		//Add the name after the checkbox
		fullForm.appendChild(document.createTextNode(showAll[place]));
		fullFormPlaceCount++;
	}
	document.getElementById("fullCheckboxDiv").appendChild(fullForm);
}
function setUpKmlArray(){
	kmls = new Array(6);
	kmlsShown = new Array(6);
	for (i=0;i<6;i++) {
		kmlsShown[i]=false;
	}	
}
<!-- Setup to get data from form based on http://www.quirksmode.org/js/formex.html -->
function toggleKmls(){
	for (i=0;i<6;i++) {
		if(document.checkboxForm.elements[i].checked!=kmlsShown[i]){
			if(kmlsShown[i]){
				//could change to removing the kml from kmls - depends on whether having previously selected it means it may want to be selected again, and the costs of recreation vs storage
				kmls[i].setMap(null);
			}else{
				if(kmls[i]==null){
					kmls[i]= new google.maps.KmlLayer();
					kmls[i].setUrl("https://sturents.com/geo/"+document.checkboxForm.elements[i].name+".kml");
					alert("Created: "+document.checkboxForm.elements[i].name);
				}
				kmls[i].setMap(map);
			}
			kmlsShown[i]=!kmlsShown[i];
	   }
	}	
}
var singleKmls=[];//The KmlLayers created by the singleOn method, newest in [0], in age order
var singleKmlNames=[];//The strings corresponding to the KmlLayers created by the singleOn method, newest in [0], in age order
//Don't bother with order, just stick on end, do random access - when doing 1 at a time order adds nothing of use.
function singleOn(urlname){
	var newKml =new google.maps.KmlLayer();
	newKml.setUrl("https://sturents.com/geo/"+urlname+".kml");
	newKml.setMap(map);
	singleKmls.splice(0,0,newKml);
	singleKmlNames.splice(0,0,urlname);
	//Append urlname to shown kmls in url
	if(window.location.hash.length==0){//no current kmls in url
		window.location.hash+=(urlname);
	}else{//there are kmls in url
		window.location.hash+=("&"+urlname);
	}//using hash '#' rather than search '?' makes url work nicely (search reloads page)
	//BUT back goes straight to nothing at all (in location.hash), leavng map/page same.
	//see window.onhashchange, pushState()
}
function singleOff(urlname){
	var index = singleKmlNames.indexOf(urlname);
	if(index!=-1){
		singleKmls[index].setMap(null);
		singleKmls.splice(index,1);
		singleKmlNames.splice(index,1);
		//remove urlname from url
		var paramStart = window.location.hash.indexOf(urlname);
		if(paramStart!=-1){//i.e. it's in the url
			var newHashStart = window.location.hash.substring(0,paramStart);
			var newHashEnd = window.location.hash.substring(paramStart+urlname.length)
			if(newHashEnd.length==0){//if no subsequent location in url, remove last symbol from newHashStart and set as the hash
				window.location.hash=newHashStart.substring(0,newHashStart.length-1); 
			}else{//remove the head element of newHashEnd (will be '&'), and set hash to be newHashStart followed by newHashEnd
				window.location.hash=newHashStart+newHashEnd.substring(1,newHashEnd.length);
			}
		}
	}	
}

google.maps.event.addDomListener(window, 'load', setUpMap);
</script>
</head>
<body>
<p>
Map will go below when put in.
</p>
<div id="mapArea"></div>
<form name="checkboxForm" action="#" method="get">
<!-- //reading-b-, reading, guildford-district-b-, guildford, surrey-county, surrey -->
<input type="checkbox" name="reading-b-">reading-b-
<input type="checkbox" name="kingston-upon-thames-london-boro">kingston-upon-thames-london-boro
<input type="checkbox" name="guildford-district-b-">guildford-district-b-
<input type="checkbox" name="guildford">guildford
<input type="checkbox" name="surrey-county">surrey-county
<input type="checkbox" name="surrey">surrey
<input type="button" name="refresh" value="Update map" onclick="toggleKmls(); return false"/>

</form>
<!-- Div to hold a dynamically generated form from https://sturents.com/geo/show-all -->
<div id="fullCheckboxDiv"></div>
</body>
</html>